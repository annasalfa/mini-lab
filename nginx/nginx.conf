worker_processes auto;
events { worker_connections 1024; }
http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile        on;
  keepalive_timeout  65;

  limit_req_zone $binary_remote_addr zone=rl_zone:10m rate=200r/m;
  map $request_uri $graphql_sensitive { default 0; ~^/graphql 1; }
  limit_req_zone $binary_remote_addr zone=rl_sensitive:10m rate=30r/m;

  server {
    listen 80;
    location = /graphql {
      if ($request_method != POST) { return 405; }
      if ($http_content_type !~* "application/json") { return 415; }
      client_max_body_size 256k;
      include /etc/modsecurity.d/include.conf;
      limit_req zone=rl_zone burst=50 nodelay;
      if ($graphql_sensitive) { limit_req zone=rl_sensitive burst=10 nodelay; }
      proxy_pass http://graphql_api:4000/graphql;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Request-Id $request_id;
    }
    location / {
      return 200 'OK - Nginx WAF fronting GraphQL. Use /graphql';
      add_header Content-Type text/plain;
    }
  }
}
